{{!-- Property Manager Content --}}
<main class="property-content {{theme}}">
  {{#if (eq activeTab 'owned')}}
    {{!-- Owned Properties --}}
    <section class="owned-properties">
      {{#if hasProperties}}
        <div class="property-grid">
          {{#each ownedProperties}}
            <div class="property-card {{#if this.isSelected}}selected{{/if}} {{#if this.needsMaintenance}}needs-maintenance{{/if}}"
                 data-action="selectProperty" data-property-id="{{this.id}}">

              <div class="property-image">
                {{#if this.img}}
                  <img src="{{this.img}}" alt="{{this.name}}" />
                {{else}}
                  <div class="property-placeholder">
                    <i class="fa-solid {{this.typeIcon}}"></i>
                  </div>
                {{/if}}
                <span class="property-type-badge">{{this.typeLabel}}</span>
              </div>

              <div class="property-info">
                <h4 class="property-name">{{this.name}}</h4>
                <span class="property-location">
                  <i class="fa-solid fa-map-marker-alt"></i>
                  {{this.location}}
                </span>
              </div>

              <div class="property-stats">
                <div class="stat condition" data-tooltip="{{localize 'BOBSNPC.Property.Condition'}}">
                  <i class="fa-solid fa-hammer"></i>
                  <div class="stat-bar">
                    <div class="stat-fill {{this.conditionClass}}" style="width: {{this.condition}}%"></div>
                  </div>
                  <span>{{this.condition}}%</span>
                </div>

                {{#if this.monthlyIncome}}
                  <div class="stat income" data-tooltip="{{localize 'BOBSNPC.Property.Income'}}">
                    <i class="fa-solid fa-coins"></i>
                    <span>+{{this.monthlyIncome}} gp/mo</span>
                  </div>
                {{/if}}
              </div>

              {{#if this.isRented}}
                <div class="rental-info">
                  <span class="rent-due">{{localize "BOBSNPC.Property.RentDue"}}: {{this.nextRentDate}}</span>
                  <span class="rent-amount">{{this.monthlyRent}} gp/mo</span>
                </div>
              {{/if}}

              {{#if this.hasMortgage}}
                <div class="mortgage-info">
                  <span>{{localize "BOBSNPC.Property.Mortgage"}}: {{this.mortgageRemaining}} gp</span>
                  <span>{{this.mortgagePayment}} gp/mo</span>
                </div>
              {{/if}}

              <div class="property-actions">
                <button type="button" class="action-btn" data-action="viewPropertyDetails" data-property-id="{{this.id}}"
                        data-tooltip="{{localize 'BOBSNPC.Property.Details'}}">
                  <i class="fa-solid fa-info-circle"></i>
                </button>
                <button type="button" class="action-btn" data-action="manageUpgrades" data-property-id="{{this.id}}"
                        data-tooltip="{{localize 'BOBSNPC.Property.Upgrades'}}">
                  <i class="fa-solid fa-tools"></i>
                </button>
                <button type="button" class="action-btn" data-action="manageStaff" data-property-id="{{this.id}}"
                        data-tooltip="{{localize 'BOBSNPC.Property.Staff'}}">
                  <i class="fa-solid fa-users"></i>
                </button>
                {{#if this.needsMaintenance}}
                  <button type="button" class="action-btn warning" data-action="repairProperty" data-property-id="{{this.id}}"
                          data-tooltip="{{localize 'BOBSNPC.Property.Repair'}}">
                    <i class="fa-solid fa-wrench"></i>
                  </button>
                {{/if}}
              </div>
            </div>
          {{/each}}
        </div>

        {{!-- Selected Property Details --}}
        {{#if selectedProperty}}
          <aside class="property-details">
            <header class="details-header">
              <h3>{{selectedProperty.name}}</h3>
              <span class="property-value">{{localize "BOBSNPC.Property.Value"}}: {{selectedProperty.currentValue}} gp</span>
            </header>

            <section class="details-section">
              <h4>{{localize "BOBSNPC.Property.Description"}}</h4>
              <p>{{selectedProperty.description}}</p>
            </section>

            {{#if selectedProperty.upgrades.length}}
              <section class="details-section">
                <h4>{{localize "BOBSNPC.Property.Upgrades"}}</h4>
                <ul class="upgrades-list">
                  {{#each selectedProperty.upgrades}}
                    <li>
                      <i class="fa-solid {{this.icon}}"></i>
                      <span>{{this.name}}</span>
                    </li>
                  {{/each}}
                </ul>
              </section>
            {{/if}}

            {{#if selectedProperty.staff.length}}
              <section class="details-section">
                <h4>{{localize "BOBSNPC.Property.Staff"}}</h4>
                <ul class="staff-list">
                  {{#each selectedProperty.staff}}
                    <li>
                      <span class="staff-name">{{this.name}}</span>
                      <span class="staff-role">{{this.role}}</span>
                      <span class="staff-wage">{{this.wage}} gp/mo</span>
                    </li>
                  {{/each}}
                </ul>
              </section>
            {{/if}}

            <section class="details-section finances">
              <h4>{{localize "BOBSNPC.Property.Finances"}}</h4>
              <div class="finance-row">
                <span>{{localize "BOBSNPC.Property.Income"}}:</span>
                <span class="positive">+{{selectedProperty.totalIncome}} gp/mo</span>
              </div>
              <div class="finance-row">
                <span>{{localize "BOBSNPC.Property.Expenses"}}:</span>
                <span class="negative">-{{selectedProperty.totalExpenses}} gp/mo</span>
              </div>
              <div class="finance-row total">
                <span>{{localize "BOBSNPC.Property.NetIncome"}}:</span>
                <span class="{{#if (gt selectedProperty.netIncome 0)}}positive{{else}}negative{{/if}}">
                  {{#if (gt selectedProperty.netIncome 0)}}+{{/if}}{{selectedProperty.netIncome}} gp/mo
                </span>
              </div>
            </section>

            <div class="details-actions">
              <button type="button" class="property-btn" data-action="collectIncome" data-property-id="{{selectedProperty.id}}"
                      {{#unless selectedProperty.hasUnclaimedIncome}}disabled{{/unless}}>
                <i class="fa-solid fa-hand-holding-dollar"></i>
                {{localize "BOBSNPC.Property.CollectIncome"}}
                {{#if selectedProperty.hasUnclaimedIncome}}
                  ({{selectedProperty.unclaimedIncome}} gp)
                {{/if}}
              </button>
              <button type="button" class="property-btn danger" data-action="sellProperty" data-property-id="{{selectedProperty.id}}">
                <i class="fa-solid fa-sign-hanging"></i>
                {{localize "BOBSNPC.Property.Sell"}}
              </button>
            </div>
          </aside>
        {{/if}}
      {{else}}
        <div class="no-properties">
          <i class="fa-solid fa-house"></i>
          <p>{{localize "BOBSNPC.Property.NoProperties"}}</p>
          <button type="button" data-action="setTab" data-tab="browse">
            {{localize "BOBSNPC.Property.BrowseListings"}}
          </button>
        </div>
      {{/if}}
    </section>

  {{else if (eq activeTab 'browse')}}
    {{!-- Available Properties --}}
    <section class="browse-properties">
      <div class="browse-filters">
        <select name="typeFilter" data-action="setTypeFilter">
          <option value="all">{{localize "BOBSNPC.Property.AllTypes"}}</option>
          {{#each propertyTypes}}
            <option value="{{this.id}}" {{#if this.selected}}selected{{/if}}>{{this.label}}</option>
          {{/each}}
        </select>

        <select name="priceSort" data-action="setPriceSort">
          <option value="low">{{localize "BOBSNPC.Property.PriceLowHigh"}}</option>
          <option value="high">{{localize "BOBSNPC.Property.PriceHighLow"}}</option>
        </select>

        <div class="price-range">
          <label>{{localize "BOBSNPC.Property.MaxPrice"}}:</label>
          <input type="number" name="maxPrice" value="{{maxPriceFilter}}" placeholder="{{localize 'BOBSNPC.Property.Any'}}" />
        </div>
      </div>

      <div class="property-grid browse">
        {{#each availableProperties}}
          <div class="property-card listing">
            <div class="property-image">
              {{#if this.img}}
                <img src="{{this.img}}" alt="{{this.name}}" />
              {{else}}
                <div class="property-placeholder">
                  <i class="fa-solid {{this.typeIcon}}"></i>
                </div>
              {{/if}}
              <span class="property-type-badge">{{this.typeLabel}}</span>
              {{#if this.isNew}}
                <span class="new-badge">{{localize "BOBSNPC.Property.NewListing"}}</span>
              {{/if}}
            </div>

            <div class="property-info">
              <h4 class="property-name">{{this.name}}</h4>
              <span class="property-location">
                <i class="fa-solid fa-map-marker-alt"></i>
                {{this.location}}
              </span>
            </div>

            <div class="property-features">
              {{#if this.size}}
                <span class="feature">
                  <i class="fa-solid fa-ruler-combined"></i>
                  {{this.size}}
                </span>
              {{/if}}
              {{#if this.rooms}}
                <span class="feature">
                  <i class="fa-solid fa-door-open"></i>
                  {{this.rooms}} {{localize "BOBSNPC.Property.Rooms"}}
                </span>
              {{/if}}
              {{#if this.potentialIncome}}
                <span class="feature income">
                  <i class="fa-solid fa-coins"></i>
                  ~{{this.potentialIncome}} gp/mo
                </span>
              {{/if}}
            </div>

            <div class="property-pricing">
              <div class="price-option purchase">
                <span class="price-label">{{localize "BOBSNPC.Property.Purchase"}}:</span>
                <span class="price-amount">{{this.purchasePrice}} gp</span>
              </div>
              {{#if this.rentalPrice}}
                <div class="price-option rental">
                  <span class="price-label">{{localize "BOBSNPC.Property.Rent"}}:</span>
                  <span class="price-amount">{{this.rentalPrice}} gp/mo</span>
                </div>
              {{/if}}
              {{#if this.mortgageAvailable}}
                <div class="mortgage-option">
                  <span>{{localize "BOBSNPC.Property.MortgageAvailable"}}</span>
                  <span>{{this.downPayment}} gp down</span>
                </div>
              {{/if}}
            </div>

            <div class="property-actions">
              <button type="button" class="listing-btn" data-action="viewListing" data-property-id="{{this.id}}">
                <i class="fa-solid fa-eye"></i>
                {{localize "BOBSNPC.Property.ViewDetails"}}
              </button>
              <button type="button" class="listing-btn primary" data-action="purchaseProperty" data-property-id="{{this.id}}"
                      {{#unless this.canAfford}}disabled{{/unless}}>
                <i class="fa-solid fa-key"></i>
                {{localize "BOBSNPC.Property.Buy"}}
              </button>
              {{#if this.rentalPrice}}
                <button type="button" class="listing-btn secondary" data-action="rentProperty" data-property-id="{{this.id}}"
                        {{#unless this.canAffordRent}}disabled{{/unless}}>
                  <i class="fa-solid fa-file-signature"></i>
                  {{localize "BOBSNPC.Property.Rent"}}
                </button>
              {{/if}}
            </div>
          </div>
        {{else}}
          <div class="no-listings">
            <i class="fa-solid fa-house-circle-xmark"></i>
            <p>{{localize "BOBSNPC.Property.NoListings"}}</p>
          </div>
        {{/each}}
      </div>
    </section>
  {{/if}}
</main>
